/*
 * Wazuh Vulnerability scanner - Database Feed Manager
 * Copyright (C) 2015, Wazuh Inc.
 * May 1, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "databaseFeedManager.hpp"
#include "eventDecoder.hpp"
#include "scanDispatcher.hpp"
#include "storeModel.hpp"

DatabaseFeedManager::DatabaseFeedManager(const nlohmann::json& configuration)
{
    // Subscription to syscollector events.
    m_contentUpdateSubscription =
        std::make_unique<RouterSubscriber>("content_vulnerability_scanner", "vulnerability_scanner");

    m_contentUpdateSubscription->subscribe(
        [](const std::vector<char>& message)
        {
            auto eventContext = std::make_shared<EventContext>();
            auto eventDecoder = std::make_shared<EventDecoder>();
            eventDecoder->setLast(std::make_shared<StoreModel>());
            eventDecoder->setLast(std::make_shared<ScanDispatcher>());

            eventDecoder->handleRequest(eventContext);
        });
}

